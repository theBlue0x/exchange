<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Blue0x Decentralized Exchange">
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Blue0x | EXCHANGE</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-reset.css" rel="stylesheet">
  <link href="assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet">
  <link href="css/style-responsive.css" rel="stylesheet" />
  <style>
    .input-group-addon {
      border:none;
      background-color:#2a84f8;
      color:white;
      font-weight:700;
    }
    .panel-heading {
      color:white;
      background-color:#2a84f8;
    }
    .panel{
      background-color: #0b0a0e;
      border: none;
      margin-top: 2vh;
    }
    .panel-body {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    p {
      color: #d1d1d1;
      font-weight: 600;
    }
    .modal { 
      background-color:#24242a!important; 
      border-radius: 0px;
      border: none;
    }
  </style>
</head>
<body class="full-width" onload="setAccountNumber();">
  <section id="container">
    <script type="text/javascript" src="js/menu.js"></script>
    <section id="main-content">
      <section class="wrapper">
          <div class="col-sm-6 col-sm-offset-3">
            <section class="panel">
              <header class="panel-heading">
                <span>Quick Swap</span>
              </header>
              	<div class="panel-body" align="center" style="color:#d1d1d1;">
              		<div id="txMessage">
              		<h4>You Send</h4>
              		<div class="input-group" style="max-width:300px;">
              			<span class="input-group-addon">Currency</span>
              			<select id="baseCurrency" class="form-control" onchange="clearAmounts();" style="border:0.1px solid #b7b7b7">
              			</select>
              		</div>
              		<br/>
              		<div class="input-group" style="max-width:300px;">
              			<span class="input-group-addon">&nbsp;Amount&nbsp;</span>
              			<input type="number" id="baseAmount" required="required" class="form-control" placeholder="0" onkeyup="preview();" style="border:0.1px solid #b7b7b7">
              		</div>
              		<i class="fa fa-arrow-down" style="margin-top:24px;margin-bottom:8px;"></i>
              		<h4>You Receive</h4>
              		<div class="input-group" style="max-width:300px;">
              			<span class="input-group-addon">&nbsp;Amount&nbsp;</span>
              			<input type="text" id="targetAmount" required="required" placeholder="0" class="form-control" style="border:0.1px solid #b7b7b7">
              		</div>
              		<br/>
              		<div class="input-group" style="max-width:300px;">
              			<span class="input-group-addon">Currency</span>
              			<select id="targetCurrency" class="form-control" onchange="clearAmounts();" style="border:0.1px solid #b7b7b7">
              			</select>
              		</div>
              		<br/>
              		<div id="rateDiv"><i>Effective Swap Rate: <span id="rateBLX"></span></i></div>
              		<span id="modalError" style="color:red;"></span>
              		<br/>
                    <button type="button" style="margin-bottom:40px" class="btn btn-info" onclick="swapModal();">&nbsp;Preview&nbsp;</button>
            	</div>
            	</div>

              <div class="modal fade" id="swapModal">
                <div class="modal-dialog">
                  <div class="modal-content" >
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title"><b>Preview Swap</b></h4>
                    </div>
                    <div class="modal-body" align="center" style="color:white;">
                      <span id="modalRate" style="display:none;"></span>
                      <span id="modalBaseAmount" style="display:none;"></span>
                      <p>Amount to Swap:</p>
                      <div class="input-group" style="max-width:300px;">
                        <span id="modalBaseAmountDisplay" class="form-control"></span>
                        <span id="modalCurrencyAdd" class="input-group-addon"></span>
                      </div>
                      <br/>
                      <p>Effective Rate:</p>
                      <div class="input-group" style="max-width:300px;">
                        <span id="modalRateDisplay"  class="form-control"></span>
                        <span class="input-group-addon">&nbsp;BLX&nbsp;</span>
                      </div>
                      <br/>
                      <p>You Receive:</p>
                      <div class="input-group" style="max-width:300px;">
                        <span id="modalTargetAmount" class="form-control"></span>
                        <span class="input-group-addon">&nbsp;BLX&nbsp;</span>
                      </div>
                      <br/>
                      <span id="buyModalRateNQT" style="display:none;"></span>
                      <br/>
                      <div class="form-group" style="max-width:400px;color:white;">
                        <label for="secretPhrase"><b>Your Account Secret Phrase:</b></label>
                    <!--button type="button" class="btn btn-qr btn-xs" data-toggle="modal" data-target="#reader1">
                      <i class="fa fa-qrcode"></i>
                    </button-->
                    <div class="iconic-input">
                      <i class="fa fa-key"></i>
                      <input type="password" class="form-control" id="modalSecretPhrase" placeholder="required">
                      <div id="modalErrorMessage"></div>
                    </div>
                  </div>
                  <br/>
                  <br/>
                  <p><i style="float:right;">The cost of this transaction is 1 BLX</i></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-info" onclick="swap();" data-dismiss="modal">Confirm</button>
                </div>
              </div>
            </div>
            </section>
          </div>
        </div>
      </section>
    </section>
  </section>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/constants.js"></script>
  <script src="js/freemarket_scripts.js"></script>
  <script>
  	var currency = {
  		USDX: ["BLX"],
  		AUDX: ["BLX"],
  		CADX: ["BLX"],
  		CHFX: ["BLX"],
  		CNYX: ["BLX"],
  		EURX: ["BLX"],
  		GBPX: ["BLX"],
  		IRRX: ["BLX"],
  		IQDX: ["BLX"],
  		JPYX: ["BLX"],
  		NZDX: ["BLX"],
  		RUBX: ["BLX"]
  	};
  	function populateSelect(id, values) {
  		var $select = $(id);
  		$select.empty();
  		values.forEach(function(value) {
  			var $option = $("<option value='" + value + "'>" + value + "</option>");
  			$select.append($option);
  		});}
  		$("#baseCurrency").on("change", function() {
  			var key = $(this).val();
  			populateSelect("#targetCurrency", currency[key]);
  		});
  		populateSelect("#baseCurrency", Object.keys(currency));
  		populateSelect("#targetCurrency", currency[$("#baseCurrency").val()]);
  	</script>
  	<script>
  		function preview(){
  		var baseCurrency = $("#baseCurrency").val();
  				$.getJSON(Constants.apiUrl,{
  					requestType: "getCurrency",
  					code: $("#baseCurrency").val()
  				},
  				function(code){
  					var currencyCode = code.currency;
  					$.getJSON(Constants.apiUrl, {
  						requestType: "getAvailableToSell",
  						currency: currencyCode,
  						units: $("#baseAmount").val()
  					}, 
  					function(request) {
              var error = request.errorDescription;
              if (!error){
  						var rate = request.rateNQT/1000000;
  						var amountNeeded = request.amountNQT/1000000;
  						var baseAmount = $("#baseAmount").val();
  						$("#targetAmount").val(amountNeeded);
  						document.getElementById("rateDiv").style.display = "block";
  						$("#rateBLX").html('<span>' + rate + ' BLX</span>');
            } else {
              document.getElementById("rateDiv").style.display = "block";
              $("#rateBLX").html('<p style="color:red">' + error + '</p>');
            }
  					})
          })}
 </script>
 <script>
  	function clearAmounts() {
  		$("#baseAmount").val('');
  		$("#targetAmount").val('');
  		document.getElementById("rateDiv").style.display = "none";
  	}
 </script>
 <script>
 	function swapModal() {
	var baseCurrency = $("#baseCurrency").val();
 			$.getJSON(Constants.apiUrl,{
 				requestType: "getCurrency",
 				code: $("#baseCurrency").val()
 			},
 			function(code){
 				var currencyCode = code.currency;
 				$.getJSON(Constants.apiUrl, {
 					requestType: "getAvailableToSell",
 					currency: currencyCode,
 					units: $("#baseAmount").val()
 				}, 
 				function(request) {
 					var error = request.errorDescription;
 					if (!error){
 					var rate = request.rateNQT/1000000;
 					var amountNeeded = request.amountNQT/1000000;
 					var baseAmount = $("#baseAmount").val();
 					var targetCurrency = $("#targetCurrency").val();
 					if (amountNeeded >= baseAmount){
 					$("#swapModal").modal();
          $("#modalCurrencyAdd").html(baseCurrency);
 					$("#modalRate").text(rate);
 					$("#modalRateDisplay").html(rate);
 					$("#modalBaseAmount").html(baseAmount);
 					$("#modalBaseAmountDisplay").html(baseAmount);
 					$("#modalTargetAmount").html(amountNeeded);
 					} else {
 						$("#modalError").html("Unable to fill order amount");
 					}
 				} else {
 					$("#modalError").html(error);
 				}})})
 		} 
</script>
<script>
	function swap() {
		var baseCurrency = $("#baseCurrency").val();
 			$.getJSON(Constants.apiUrl,{
 				requestType: "getCurrency",
 				code: $("#baseCurrency").val()
 			},
 			function(code){
 				var currencyCode = code.currency;
 				$.getJSON(Constants.apiUrl, {
 					requestType: "getAvailableToSell",
 					currency: currencyCode,
 					units: $("#baseAmount").val()
 				}, 
 				function(request) {
 						var rate = request.rateNQT;
 						var secretPhrase = $("#modalSecretPhrase").val();
 						var units = $("#baseAmount").val() * 100;
 						$.post(Constants.apiUrl, {
 							requestType: "currencySell",
 							currency: currencyCode,
 							rateNQT: rate,
 							units: units,
 							secretPhrase: secretPhrase,
 							deadline: 60,
 							feeNQT: 100000000
 						},
 						function(result) {
              var error = result.errorDescription;
 							if (!error){
 								var tx = JSON.parse(result);
 								var txId = tx.transaction;
 								$("#txMessage").html("<h4><b>Swap Successful!<br/><br/>TX ID: " + txId + "</b></h4>");
 							} else {
 								$("#txMessage").html(error);
 	}})})})}
</script>
</body>
</html>